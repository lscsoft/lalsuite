# ----------------------------------------------------------------------
# LALSuite: RPM package-level build
# ----------------------------------------------------------------------

# -- from https://git.ligo.org/computing/gitlab-ci-templates/-/blob/master/rhel.yml

.install-dnf: &install-dnf
  if ! command -v dnf &> /dev/null; then
      if grep -q "scientificlinux:7" /etc/os-release; then yum -y -q install yum-conf-extras; fi;
      yum -y -q install dnf;
      if grep -q "scientificlinux:7" /etc/os-release; then ln -sv /etc/yum/vars/sl* /etc/dnf/vars/; fi;
  fi

# find yum/dnf
.set-dnf-variable: &set-dnf-variable
  if command -v yum &> /dev/null; then
      DNF="yum";
  else
      DNF="dnf";
  fi

# disable repos the user doesn't want
.disable-repos: &disable-repos
  _config_manager_args="--disable ${DISABLE_REPOS}" &&
  _install_args="--disablerepo ${DISABLE_REPOS/ /,}" &&
  if [ -z "${DISABLE_REPOS}" ]; then
      true;
  elif command -v yum &> /dev/null; then
      yum -y -q install ${_install_args} "yum-utils" &&
      yum-config-manager ${_config_manager_args} 1>/dev/null;
  else
      dnf -y -q install ${_install_args} "dnf-command(config-manager)" &&
      dnf config-manager ${_config_manager_args};
  fi

# configure yum/dnf to cache packages locally
.configure-rpm-cache: &configure-rpm-cache
  _config_manager_args="--save --setopt=cachedir=${RPM_CACHE_DIR:=${CI_PROJECT_DIR}/.cache/rpm} --setopt=keepcache=1" &&
  if command -v yum &> /dev/null; then
      yum -y -q install "yum-utils" &&
      yum-config-manager ${_config_manager_args} 1>/dev/null;
  else
      dnf -y -q install "dnf-command(config-manager)" &&
      dnf config-manager ${_config_manager_args};
  fi

# enable the powertools repo for Centos 8
.enable-powertools: &enable-powertools
  if grep -q "platform:el8" /etc/os-release && "${POWERTOOLS}"; then
      dnf -y -q install dnf-plugins-core &&
      dnf config-manager --set-enabled powertools;
  fi

# install and configure EPEL
.install-epel: &install-epel
  if [ "${EPEL}" = true ]; then
      if command -v yum &> /dev/null; then
          yum -y -q install epel-release && yum -y -q install epel-rpm-macros;
      else
          dnf -y -q install epel-release && dnf -y -q install epel-rpm-macros;
      fi
  fi

.disable-python-package-index: &disable-python-package-index |
  # disable Python from downloading packages on-the-fly
  # everything should be specified as BuildRequires

  # if not a disposable environment, we will not create files outside of the
  # CI_PROJECT_DIR
  if [ ! "${CI_DISPOSABLE_ENVIRONMENT}" = true ]; then
      echo -e "\x1B[93mCannot safely disable easy_install index-url in a non-disposable environment.\x1B[0m";
  # if the user didn't opt-out, then create ~/.pydistutils.cfg
  elif [ "${DISABLE_PYTHON_PACKAGE_INDEX}" = true ]; then
      export PIP_NO_INDEX=1;
      cat > ~/.pydistutils.cfg <<EOF
  [easy_install]
  index-url = CI_DISABLED_INDEX_URL
  EOF
      echo "Created ~/.pydistutils.cfg to disable pip/setuptools downloading packages.";
      echo "All build requirements should be specified in the RPM spec file and installed using yum-builddep.";
  else
      echo "User disabled disabling Python package index, ~/.pydistutils.cfg not created.";
  fi

# -- RHEL caching -----------
# configure yum/dnf to cache
# RPMs locally and gitlab-ci
# to cache the cache
# ---------------------------

.rhel:cache:
  image: rockylinux:8
  variables:
    RPM_CACHE_DIR: "${CI_PROJECT_DIR}/.cache/rpm"
  before_script:
    - *configure-rpm-cache
  cache:
    key: "${CI_JOB_NAME}"
    paths:
      - .cache/rpm

# -- generic job ------------
# default job template for
# RHEL-based jobs, including
# caching and hooks for EPEL
# and CentOS 8 PowerTools
# ---------------------------

.rhel:base:
  extends:
    - .rhel:cache
  variables:
    EPEL: "false"
    POWERTOOLS: "false"
  before_script:
    - *install-dnf
    - *set-dnf-variable
    - *disable-repos
    - *configure-rpm-cache
    - *enable-powertools
    - *install-epel

# -- binary RPM build -------
# build an RPM from an SRPM
# ---------------------------

.rhel:rpm:
  extends:
    - .rhel:base
  variables:
    # disable downloading packages from PyPI by defaults
    DISABLE_PYTHON_PACKAGE_INDEX: "true"
    # if 'true' enable EPEL repo
    EPEL: "false"
    # probably don't need the git repo
    GIT_STRATEGY: none
    # if 'true' enable CentOS PowerTools repo
    POWERTOOLS: "false"
    # options to pass to rpmbuild
    RPMBUILD_OPTIONS: ""
  before_script:
    # standard config
    # NOTE: we don't use !reference tags here because
    # [DMM] they don't support nesting, and we want
    #       users to be able to use !reference tags
    - *install-dnf
    - *set-dnf-variable
    - *disable-repos
    - *configure-rpm-cache
    - *enable-powertools
    - *install-epel
    - *disable-python-package-index
    # install rpmbuild and yum-builddep
    - dnf -y -q install
          findutils
          rpm-build
          yum-utils
  script:
    # install build dependencies for src rpm
    - yum-builddep -y ${SRPM:="${CI_PROJECT_NAME}-*.src.rpm"}
    # build binary rpms and move them into this directory
    - xargs -t rpmbuild --rebuild --define "_rpmdir $(pwd)" ${SRPM} <<< ${RPMBUILD_OPTIONS}
    # list the contents of the rpms
    - for rpmf in */*.rpm; do
          rpmname=$(basename ${rpmf}) &&
          echo "===== ${rpmname}" &&
          rpm -qp --info "${rpmf}" &&
          echo "-- Files:" &&
          rpm -qp --list "${rpmf}" &&
          echo "-- Provides:" &&
          rpm -qp --provides "${rpmf}" &&
          echo "-- Conflicts:" &&
          rpm -qp --conflicts "${rpmf}" &&
          echo "-- Requires:" &&
          rpm -qp --requires "${rpmf}";
      done
    # archive the rpms in the base directory
    - mv -v */*.rpm .
  artifacts:
    paths:
      - "*.rpm"
    exclude:
      - "*.src.rpm"

# -- templates

.rpmbuild:
  extends:
    - .rhel:rpm
    - .build-from-tarball
  variables:
    # disable repos we don't use
    DISABLE_REPOS: "htcondor osg"
    # parallelise the build (rpmbuild uses this variable by default)
    RPM_BUILD_NCPUS: ${CPU_COUNT}
    # where to build things (not a standard variable name)
    RPM_BUILD_TOPDIR: "${CI_PROJECT_DIR}/rpmbuild"
  # before_script comes from .rhel:rpm
  script:
    - !reference [.build-init]
    # build a yum repo from the upstream packages
    - |
      if [ -d rpmbuild ]; then
          retry yum install -y -q createrepo
          LOCAL_REPO="${CI_PROJECT_DIR}/local-builds"
          cp -r rpmbuild/RPMS ${LOCAL_REPO}
          createrepo --quiet --workers "${CPU_COUNT}" "${LOCAL_REPO}"
          cat > /etc/yum.repos.d/local-builds.repo <<EOF
      [local-builds]
      name=Local builds
      baseurl=file://${LOCAL_REPO}
      enabled=1
      gpgcheck=0
      EOF
      fi
    # install srpm dependencies
    - retry yum install -y -q
          igwn-packaging-tools
          xz
    # build src.rpm
    - PACKAGE=${CI_JOB_NAME%%:*}
    - cd ${PACKAGE}/
    - TARBALL=$(ls -t1 ${PACKAGE}-*.tar.* | head -n1 | xargs readlink -f)
    - rpmbuild -ts --define "_topdir ${RPM_BUILD_TOPDIR}" ${TARBALL}
    - SRPM=${RPM_BUILD_TOPDIR}/SRPMS/${PACKAGE}-*.src.rpm
    # install build dependencies
    - retry yum-builddep -y ${SRPM}
    # print installed packages
    - yum list installed --quiet
    # build binary rpms and print details of what we got
    - rpmbuild --rebuild --noclean --define "_topdir ${RPM_BUILD_TOPDIR}" ${SRPM}
    # print package info
    - set +x
    - for rpmf in ${CI_PROJECT_DIR}/rpmbuild/RPMS/*/*${PACKAGE}-*.rpm; do
          echo "===== ${rpmf}" &&
          rpm -qlp "${rpmf}" &&
          echo "Files:" &&
          rpm -qip "${rpmf}" &&
          echo "Provides:" &&
          rpm -qp --provides "${rpmf}" &&
          echo "Requires:" &&
          rpm -qp --requires "${rpmf}";
      done
    # install the packages we built
    - retry yum -y -q install ${CI_PROJECT_DIR}/rpmbuild/RPMS/*/*${PACKAGE}-*.rpm
    # lint packages (RPM files only)
    - |
      tar -O -xf ${TARBALL} $(tar -tf ${TARBALL} | grep '/rpmlintrc$') > rpmlintrc
      echo "----- rpmlintrc"
      grep . rpmlintrc
      echo "----- rpmlintrc"
    - rpmlint
          -f rpmlintrc
          ${CI_PROJECT_DIR}/rpmbuild/RPMS/*/*${PACKAGE}-*.rpm
          > rpmlint.out || true
    - cat rpmlint.out
    # create a codeclimate report from the rpmlint report
    - unset PIP_NO_INDEX && rm -rf ~/.pydistutils.cfg
    - !reference [.python-venv]
    - retry python -m pip install rpmlint-codeclimate
    - |
      python -m rpmlint_codeclimate rpmlint.out -s ${PACKAGE}.spec -o ${CI_PROJECT_DIR}/code-quality-rpmlint.json
      sed -i \
        -e "s|${PACKAGE}.spec|${PACKAGE}/${PACKAGE}.spec.in|g" \
        ${CI_PROJECT_DIR}/code-quality-rpmlint.json
    - !reference [.concatenate-code-quality]
  artifacts:
    expire_in: 18h
    paths:
      # build packages
      - "rpmbuild/RPMS/*/${CI_JOB_NAME%%:*}-*.rpm"
      - "rpmbuild/RPMS/*/lib${CI_JOB_NAME%%:*}-*.rpm"
      - "rpmbuild/RPMS/*/python*-${CI_JOB_NAME%%:*}-*.rpm"
      # log files
      - "rpmbuild/BUILD/**/config.log"
      - "rpmbuild/BUILD/**/test-suite.log"
      # generated sources
      - "rpmbuild/BUILD/**/swiglal_lal*_octave.cpp"
      - "rpmbuild/BUILD/**/swiglal_lal*_python.c"
    reports:
      codequality: code-quality.json
      junit: "rpmbuild/BUILD/**/*junit*.xml"
    when: always
  rules:
    - !reference [.ci-rpm, rules]
    - !reference [.ci-merge-build, rules]
    - !reference [.ci-nightly-deploy, rules]
    - !reference [.ci-lalsuite-tag-build, rules]
    - !reference [.ci-docker, rules]
    - when: never

.rpmbuild:el8:
  extends:
    - .rpmbuild
  image: quay.io/igwn/base:el8-testing

# -- builds

lal:rpm-el8:
  extends:
     - .rpmbuild:el8
     - .lal
  needs:
    - !reference [.lal, needs]

lalframe:rpm-el8:
  extends:
    - .rpmbuild:el8
    - .lalframe
  needs:
    - !reference [.lalframe, needs]
    - lal:rpm-el8

lalmetaio:rpm-el8:
  extends:
    - .rpmbuild:el8
    - .lalmetaio
  needs:
    - !reference [.lalmetaio, needs]
    - lal:rpm-el8

lalsimulation:rpm-el8:
  extends:
    - .rpmbuild:el8
    - .lalsimulation
  needs:
    - !reference [.lalsimulation, needs]
    - lal:rpm-el8

lalburst:rpm-el8:
  extends:
    - .rpmbuild:el8
    - .lalburst
  needs:
    - !reference [.lalburst, needs]
    - lal:rpm-el8
    - lalmetaio:rpm-el8
    - lalsimulation:rpm-el8

lalinspiral:rpm-el8:
  extends:
    - .rpmbuild:el8
    - .lalinspiral
  needs:
    - !reference [.lalinspiral, needs]
    - lal:rpm-el8
    - lalframe:rpm-el8
    - lalmetaio:rpm-el8
    - lalsimulation:rpm-el8
    - lalburst:rpm-el8

lalinference:rpm-el8:
  extends:
    - .rpmbuild:el8
    - .lalinference
  needs:
    - !reference [.lalinference, needs]
    - lal:rpm-el8
    - lalframe:rpm-el8
    - lalmetaio:rpm-el8
    - lalsimulation:rpm-el8
    - lalburst:rpm-el8
    - lalinspiral:rpm-el8

lalpulsar:rpm-el8:
  extends:
    - .rpmbuild:el8
    - .lalpulsar
  needs:
    - !reference [.lalpulsar, needs]
    - lal:rpm-el8
    - lalframe:rpm-el8
    - lalmetaio:rpm-el8
    - lalsimulation:rpm-el8
    - lalburst:rpm-el8
    - lalinspiral:rpm-el8
    - lalinference:rpm-el8

lalapps:rpm-el8:
  extends:
    - .rpmbuild:el8
    - .lalapps
  needs:
    - !reference [.lalapps, needs]
    - lal:rpm-el8
    - lalframe:rpm-el8
    - lalmetaio:rpm-el8
    - lalsimulation:rpm-el8
    - lalburst:rpm-el8
    - lalinspiral:rpm-el8
    - lalinference:rpm-el8
    - lalpulsar:rpm-el8
