# ----------------------------------------------------------------------
# LALSuite: Debian package-level build
# ----------------------------------------------------------------------

# -- from https://git.ligo.org/computing/gitlab-ci-templates/-/blob/master/debian.yml

# configure the apt cache
.configure-apt-cache: &configure-apt-cache
  echo "Dir::Cache \"${APT_CACHE_DIR:=${CI_PROJECT_DIR}/.cache/apt}\";" > /etc/apt/apt.conf.d/99cache.conf &&
  mkdir -p "${APT_CACHE_DIR}/archives/partial"

# update the local APT packages
.apt-update: &apt-update
  apt-get autoclean && apt-get --yes --quiet --allow-releaseinfo-change-suite update

# -- Deb caching ------------
# configure apt to cache
# packages locally and
# gitlab-ci to cache the
# cache
# ---------------------------

.debian:cache:
  image: debian
  variables:
    APT_CACHE_DIR: "${CI_PROJECT_DIR}/.cache/apt"
  before_script:
    - *configure-apt-cache
  cache:
    key: "${CI_JOB_NAME}"
    paths:
      - .cache/apt

# -- generic job ------------
# default job template for
# Debian-based jobs,
# including caching and a
# basic 'apt-get update'
# ---------------------------

.debian:base:
  extends:
    - .debian:cache
  before_script:
    # standard config
    # NOTE: we don't use !reference tags here because
    # [DMM] they don't support nesting, and we want
    #       users to be able to use !reference tags
    - *configure-apt-cache
    - *apt-update

# -- DSC build --------------
# build a debian source
# package using dpkg-source
# ---------------------------

.debian:dsc:
  extends:
    - .debian:base
  variables:
    # probably don't need the git repo
    GIT_STRATEGY: none
  before_script:
    # standard config
    # NOTE: we don't use !reference tags here because
    # [DMM] they don't support nesting, and we want
    #       users to be able to use !reference tags
    - *configure-apt-cache
    - *apt-update
    # install dpkg-source
    - apt-get -y -q install
          dpkg-dev
          ${DSC_DEPENDENCIES}
  script:
    # extract tarball
    - mkdir _dsc_src
    - tar -xf ${TARBALL:="${CI_PROJECT_NAME}*.tar.*"} -C _dsc_src --strip-components=1
    # get Source name from Debian packaging (preserve regex match if that fails)
    - |
      SOURCE_NAME=$((grep "^Source:" _dsc_src/debian/control || echo "Source: \1" ) | awk '{print $2}')
    # rename tarball for debian orig
    - _orig=$(basename ${TARBALL} | sed "s|\(.*\)-\(.*\).\(tar\..*\)|${SOURCE_NAME}_\2.orig.\3|")
    - mv -v ${TARBALL} "${_orig}"
    # create debian source package files
    - dpkg-source --build _dsc_src
  artifacts:
    paths:
      - "*.debian.tar.*"
      - "*.diff.gz"
      - "*.dsc"
      - "*.orig.tar.*"

# -- binary DEB build -------
# build one or more binary
# deban packages using
# dpkg-buildpackage
# ---------------------------

.debian:deb:
  extends:
    - .debian:base
  variables:
    # probably don't need the git repo
    GIT_STRATEGY: none
    # options for apt-get
    APT_GET_OPTIONS: "-o Debug::pkgProblemResolver=yes --no-install-recommends"
  before_script:
    # standard config
    # NOTE: we don't use !reference tags here because
    # [DMM] they don't support nesting, and we want
    #       users to be able to use !reference tags
    - *configure-apt-cache
    - *apt-update
    # install mk-build-deps and dpkg-buildpackage
    - apt-get -y -q install
          dpkg-dev
          devscripts
  script:
    # unpack source package
    - dpkg-source --extract ${DSC:="${CI_PROJECT_NAME}_*.dsc"} _deb_src
    - cd _deb_src
    # install build dependencies
    - mk-build-deps
          --tool "apt-get -y -q ${APT_GET_OPTIONS}"
          --install
          --remove
    # build debian packages
    - dpkg-buildpackage -us -uc -b
    - cd -
    # print contents of packages
    - for debf in *.deb; do
          echo "===== ${debf}";
          dpkg --info "${debf}";
          dpkg --contents "${debf}";
      done
  artifacts:
    paths:
      - "*.buildinfo"
      - "*.changes"
      - "*.deb"

# -- lint debs --------------
# run lintian against a set
# of debs
# ---------------------------

.debian:lint:
  extends:
    - .debian:base
  variables:
    # probably don't need the git repo
    GIT_STRATEGY: none
    # options to pass to lintian
    LINTIAN_OPTIONS: "--color=auto"
    # what to lint
    LINTIAN_TARGET: '*.changes'
  before_script:
    # standard config
    # NOTE: we don't use !reference tags here because
    # [DMM] they don't support nesting, and we want
    #       users to be able to use !reference tags
    - *configure-apt-cache
    - *apt-update
    # install lintian
    - apt-get -y -q install
          findutils
          lintian
  script:
    - xargs -t lintian ${LINTIAN_TARGET} <<< ${LINTIAN_OPTIONS}

# -- templates

.debuild:
  extends:
    - .debian:deb
    - .build-from-tarball
  image: quay.io/igwn/base:bookworm
  variables:
    # tell debhelper to parallelise the build
    DEB_BUILD_OPTIONS: "parallel=${CPU_COUNT}"
  # before_script: comes from .debian:deb
  script:
    - !reference [.build-init]
    - PACKAGE=${CI_JOB_NAME%%:*}
    # install extra build requirements
    - retry apt-get install -y -q -q
          lintian
          python3-venv
          xz-utils
    # setup local apt repository to house upstream packages
    - if test -n "$(find . -maxdepth 1 -name '*.deb' -print -quit)"; then
          retry apt-get -y -q -q install local-apt-repository;
          mkdir -pv /srv/local-apt-repository;
          mv -v *.deb /srv/local-apt-repository;
          /usr/lib/local-apt-repository/rebuild;
          retry apt-get -y -q update;
      fi
    # create orig tarball
    - cd ${PACKAGE}/
    - TARBALL=$(ls -t1 ${PACKAGE}-*.tar.* | head -n1 | xargs readlink -f)
    - SUFFIX=$(basename $TARBALL | sed 's/.*\.\(tar\..*\)/\1/')
    - VERSION=$(basename $TARBALL | sed 's/[^-]*-\(.*\)\.tar\..*/\1/' | tr '-' '~')
    - cd ${CI_PROJECT_DIR}/
    - cp ${TARBALL} ${PACKAGE}_${VERSION}.orig.${SUFFIX}
    # unpack tarball
    - export DEBFULLNAME="GitLab"
    - export DEBEMAIL="gitlab@git.ligo.org"
    - tar -xf ${TARBALL}
    - cd ${PACKAGE}-*/
    # update changelog
    - dch -v ${VERSION}-1 -b 'Rebuilt automatically on git.ligo.org CI'
    # install build dependencies
    - retry mk-build-deps
          --tool "apt-get -y -q -o Debug::pkgProblemResolver=yes --no-install-recommends"
          --install
          --remove
    - rm -rfv *-build-deps_*
    # build packages
    - debuild
         --prepend-path=/usr/lib/ccache --set-envvar=CCACHE_DIR=${CCACHE_DIR}
         -us -uc -r
         --lintian-opts --color=always --allow-root
    # create a codeclimate report from the lintian report
    - |
      echo "---- *lintian-overrides"
      find debian/ -name '*lintian-overrides' | sort | xargs grep -H .
      echo "---- *lintian-overrides"
    - !reference [.python-venv]
    - retry python -m pip install "lintian-codeclimate>=0.1.1"
    - |
      lintian --allow-root --fail-on none --info --color never ../${PACKAGE}_*.changes > lintian.out
      python -m lintian_codeclimate lintian.out -d . -o ${CI_PROJECT_DIR}/code-quality-lintian.json
      sed -i \
        -e "s|debian\/control|debian/control.in|g" \
        -e "s|debian\/|$PACKAGE/debian/|g" \
        ${CI_PROJECT_DIR}/code-quality-lintian.json
    # print package info
    - set +x
    - cd ${CI_PROJECT_DIR}
    - for debf in *.deb; do
          echo "===== ${debf}";
          dpkg --info "${debf}";
          dpkg --contents "${debf}";
      done
    - !reference [.concatenate-code-quality]
  artifacts:
    expire_in: 18h
    paths:
      # build packages
      - "${CI_JOB_NAME%%:*}*.changes"
      - "${CI_JOB_NAME%%:*}*.deb"
      - "lib${CI_JOB_NAME%%:*}*.deb"
      - "python*-${CI_JOB_NAME%%:*}*.deb"
      - "${CI_JOB_NAME%%:*}*.dsc"
      # log files
      - "${CI_JOB_NAME%%:*}*/**/config.log"
      - "${CI_JOB_NAME%%:*}*/**/test-suite.log"
      # generated sources
      - "${CI_JOB_NAME%%:*}*/**/swiglal_lal*_python.c"
      # the orig tarball
      - "${CI_JOB_NAME%%:*}*.orig.*"
    reports:
      codequality: code-quality.json
      junit: "${CI_JOB_NAME%%:*}-*/**/*junit*.xml"
    when: always
  rules:
    - !reference [.ci-deb, rules]
    - !reference [.ci-merge-build, rules]
    - !reference [.ci-nightly-deploy, rules]
    - !reference [.ci-lalsuite-tag-build, rules]
    - !reference [.ci-docker, rules]
    - when: never

# -- builds

lal:deb:
  extends:
    - .debuild
    - .lal
  needs:
    - !reference [.lal, needs]

lalframe:deb:
  extends:
    - .debuild
    - .lalframe
  needs:
    - !reference [.lalframe, needs]
    - lal:deb

lalmetaio:deb:
  extends:
    - .debuild
    - .lalmetaio
  needs:
    - !reference [.lalmetaio, needs]
    - lal:deb

lalsimulation:deb:
  extends:
    - .debuild
    - .lalsimulation
  needs:
    - !reference [.lalsimulation, needs]
    - lal:deb

lalburst:deb:
  extends:
    - .debuild
    - .lalburst
  needs:
    - !reference [.lalburst, needs]
    - lal:deb
    - lalmetaio:deb
    - lalsimulation:deb

lalinspiral:deb:
  extends:
    - .debuild
    - .lalinspiral
  needs:
    - !reference [.lalinspiral, needs]
    - lal:deb
    - lalframe:deb
    - lalmetaio:deb
    - lalsimulation:deb
    - lalburst:deb

lalinference:deb:
  extends:
    - .debuild
    - .lalinference
  needs:
    - !reference [.lalinference, needs]
    - lal:deb
    - lalframe:deb
    - lalmetaio:deb
    - lalsimulation:deb
    - lalburst:deb
    - lalinspiral:deb

lalpulsar:deb:
  extends:
    - .debuild
    - .lalpulsar
  needs:
    - !reference [.lalpulsar, needs]
    - lal:deb
    - lalframe:deb
    - lalmetaio:deb
    - lalsimulation:deb
    - lalburst:deb
    - lalinspiral:deb
    - lalinference:deb

lalapps:deb:
  extends:
    - .debuild
    - .lalapps
  needs:
    - !reference [.lalapps, needs]
    - lal:deb
    - lalframe:deb
    - lalmetaio:deb
    - lalsimulation:deb
    - lalburst:deb
    - lalinspiral:deb
    - lalinference:deb
    - lalpulsar:deb
